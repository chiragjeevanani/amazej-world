import React, { useMemo, useState, useEffect } from "react";
import { toast } from "react-hot-toast";
import { useTranslation } from "react-i18next";
import { useProtocol } from "@/contexts/ProtocolContext";
import { ClaimCountdown } from "@/components/Countdown";

function fmtUSDT(x) { return x === undefined ? "â€”" : "USDT " + (Number(x) / 1e18).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
function fmtTok(x) { return x === undefined ? "â€”" : (Number(x) / 1e18).toLocaleString(undefined, { maximumFractionDigits: 6 }); }
function fmtDate(s) { return !s || s === 0n ? "â€”" : new Date(Number(s) * 1000).toLocaleString(undefined, { hour12: true }); }

export default function RoyaltyRewardsComponent() {
    const { t } = useTranslation();
    const { data, actions } = useProtocol();
    const { royalty } = data;

    return (
        <div className="space-y-6">
            <section className="bg-card rounded-2xl border border-border p-6 shadow-2xl transition-colors">
                <div className="flex items-center justify-between mb-8">
                    <div>
                        <h3 className="text-2xl font-black text-card-foreground">{t('royalty.title')}</h3>
                        <p className="text-muted-foreground text-sm mt-1">{t('royalty.subtitle')}</p>
                    </div>
                    <button
                        disabled={!data?.royalty?.canClaim || actions.loading.claimRoyalty}
                        onClick={() => actions.claimRoyalty()}
                        className={`font-black text-xs uppercase tracking-widest h-10 px-6 rounded-lg transition-all ${data?.royalty?.canClaim
                            ? "bg-primary text-primary-foreground hover:bg-primary/90"
                            : "bg-secondary text-muted-foreground/50 cursor-not-allowed border border-border"
                            }`}
                    >
                        {actions.loading.claimRoyalty ? t('royalty.claiming') : data?.royalty?.canClaim ? t('royalty.claim_royalty') : t('royalty.window_locked')}
                    </button>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <DarkTile label={t('royalty.active_vip_level')} value={royalty?.activeLevel > 0 ? `${royalty.activeLevel}` : t('royalty.none')} />
                    <DarkTile label={t('royalty.total_vip_in_level')} value={Number(royalty?.activeMembersCount || 0)} />
                    <DarkTile label={t('royalty.claimed_days')} value={Number(royalty?.claimDaysUsed || 0)} />
                    <DarkTile label={t('royalty.total_claimed')} value={fmtUSDT(royalty?.totalClaimed).replace('USDT ', '')} />
                    <DarkTile label={t('royalty.royalty_available')} value={fmtUSDT(royalty?.usdt).replace('USDT ', '')} highlight={false} />

                    <DarkTile label={t('royalty.last_claimed_date')} value={fmtDate(royalty?.lastClaimDate)} />

                    <div className="p-4 bg-secondary/50 rounded-xl border border-border">
                        <div className="text-[10px] font-black text-muted-foreground uppercase tracking-widest mb-1">{t('royalty.next_claimed_in')}</div>
                        <div className="text-xl font-black text-card-foreground/90">
                            {royalty?.lastClaimDate ? (
                                <ClaimCountdown nextClaimAtSec={(royalty?.lastClaimDate + (data?.claimPeriod || 0n))} />
                            ) : t('royalty.not_scheduled')}
                        </div>
                    </div>

                    <DarkTile
                        label={t('royalty.is_permanent')}
                        value={royalty?.isPermanent ? t('royalty.yes') : t('royalty.no')}
                    />
                </div>
            </section>
        </div>
    );
}

function DarkTile({ label, value, highlight }) {
    return (
        <div className="p-4 bg-secondary/50 rounded-xl border border-border">
            <div className="text-[10px] font-black text-muted-foreground uppercase tracking-widest mb-1">{label}</div>
            <div className={`text-xl font-black ${highlight ? 'text-card-foreground' : 'text-card-foreground/90'}`}>{value}</div>
        </div>
    );
}
